<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Poll</title>
    <script type="module">
      import init, { get_poll, vote, create_poll } from './pkg/client.js';

      (async () => {
        await init();

        let pollIdInput = document.getElementById('poll-id-input');

        pollIdInput.addEventListener('change', async () => {
          let pollId = pollIdInput.value.trim();

          if (pollId === '') {
            alert('Please enter a valid poll ID.');
            return;
          }

          let poll = await get_poll(pollId);

          document.getElementById('poll-title').innerText = poll.title();

          let options = poll.options();
          let optionsList = document.getElementById('poll-options');

          optionsList.innerHTML = '';

          options.forEach((option, index) => {
            let listItem = document.createElement('li');
            listItem.innerText = `${option.name()} - Votes: ${option.vote_count()}`;

            let voteButton = document.createElement('button');
            voteButton.innerText = 'Vote';
            voteButton.addEventListener('click', () => {
              vote(pollId, index);
            });

            listItem.appendChild(voteButton);
            optionsList.appendChild(listItem);
          });
        });

        document.getElementById('create-poll-form').addEventListener('submit', async (e) => {
          e.preventDefault();

          let title = document.getElementById('poll-title-input').value;
          let options = Array.from(document.querySelectorAll('.poll-option-input')).map(input => input.value).filter(value => value.trim() !== '');

          if (title.trim() === '' || options.length === 0) {
            alert('Please provide a title and at least one option.');
            return;
          }

          await create_poll(title, options);
          alert('Poll created successfully!');
        });

        document.getElementById('add-option-button').addEventListener('click', () => {
          let optionInput = document.createElement('input');
          optionInput.type = 'text';
          optionInput.className = 'poll-option-input';
          optionInput.placeholder = 'Option';

          document.getElementById('poll-options-container').appendChild(optionInput);
        });
      })();
    </script>
  </head>
  <body>
    <label for="poll-id-input">Poll ID:</label>
    <input type="text" id="poll-id-input" placeholder="Enter poll ID">

    <h1 id="poll-title">Loading poll...</h1>
    <ul id="poll-options"></ul>

    <h2>Create a New Poll</h2>
    <form id="create-poll-form">
      <label for="poll-title-input">Poll Title:</label>
      <input type="text" id="poll-title-input" placeholder="Enter poll title">

      <div id="poll-options-container">
        <input type="text" class="poll-option-input" placeholder="Option">
      </div>

      <button type="button" id="add-option-button">Add Option</button>
      <button type="submit">Create Poll</button>
    </form>
  </body>
</html>

